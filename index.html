<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุชุณุฌูู ุญุถูุฑ ูุญุงุถุฑุงุช ููุฏููู ุงูุฃุทูุงู</title>
  <link rel="stylesheet" href="styles.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    :root { --app-font: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    html, body { font-family: var(--app-font); }
  </style>
</head>
<body>
<header class="site-header">
  <h1>ุชุณุฌูู ุญุถูุฑ ูุญุงุถุฑุงุช ุงูุฃุทูุงู ุงูุฏูุนุฉ 59</h1>
  <p class="sub">ุงูุชุจ ุงุณูู ูุฑูู ุฌููุณู ูุงุฎุชุฑ ููู ุงูุญุถูุฑ. ุงูุฃูุงูู ูุญุฏูุฏุฉ ููู ุฑุบุจุฉ.</p>
</header>

<main class="grid">
  <section class="card">
    <h2 class="card-title">ุจูุงูุงุช ุงูุทุงูุจ</h2>
    <form class="form" id="pref-form">
      <label for="name">ุงูุงุณู ุฑุจุงุนู (ุจุงููุบุฉ ุงูุนุฑุจูุฉ)</label>
      <input id="name" name="name" type="text" required autocomplete="off"/>

      <label for="seat">ุฑูู ุงูุฌููุณ (ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ)</label>
      <input id="seat" name="seat" type="text" required inputmode="numeric" placeholder="ูุซุงู: 1234"/>

      <label for="choice">ุงูุฑุบุจุฉ</label>
      <select id="choice" name="choice" required>
        <option value="" selected disabled>ุงุฎุชุฑ ุฑุบุจุชู</option>
      </select>

      <button class="btn-primary" id="submitBtn" type="submit">ุชุณุฌูู ุงูุฑุบุจุฉ</button>
      <button class="btn-ghost" id="checkOpen" type="button">๐งฉ ุงุฎุชุจุงุฑ ุงูุชุณุฌูู</button>
    </form>
    <div id="status" class="status" aria-live="polite"></div>
  </section>

  <section class="card">
    <h2 class="card-title">ุฅุญุตุงุฆูุงุช ูุจุงุดุฑุฉ</h2>
    <div id="stats" class="stats"></div>
  </section>

  <section class="card">
    <h2 class="card-title">ููุญุฉ ุงููุดุฑููู</h2>
    <button class="btn-ghost" id="adminOpen">ุชุณุฌูู ุงูุญุถูุฑ (ููุฃุฏูู)</button>
    <p class="muted">ุฎุงุต ุจุงููุณุคูููู ููุท.</p>
  </section>
</main>

<!-- ูุงูุฐุฉ ุงุฎุชุจุงุฑ ุงูุชุณุฌูู -->
<dialog class="dialog" id="checkDialog">
  <form class="dialog-card" id="checkForm" method="dialog">
    <h3>ุงุฎุชุจุงุฑ ุงูุชุณุฌูู</h3>
    <label>ุฑูู ุงูุฌููุณ</label>
    <input id="checkSeat" required inputmode="numeric" placeholder="ูุซุงู: 1234"/>
    <menu class="dialog-actions">
      <button class="btn-ghost" value="cancel">ุฅุบูุงู</button>
      <button class="btn-primary" id="checkBtn" value="check">ุนุฑุถ ุงูุจูุงูุงุช</button>
    </menu>
    <div id="checkResult" class="status"></div>
  </form>
</dialog>

<!-- ูุงูุฐุฉ ุงูุฃุฏูู -->
<dialog class="dialog" id="adminDialog">
  <form class="dialog-card" id="adminLoginForm" method="dialog">
    <h3>ุชุณุฌูู ุฏุฎูู ุงููุดุฑู</h3>
    <label>ุงุณู ุงููุณุชุฎุฏู</label>
    <input id="adminUser" autocomplete="username" required/>
    <label>ูููุฉ ุงูุณุฑ</label>
    <input id="adminPass" type="password" autocomplete="current-password" required/>
    <menu class="dialog-actions">
      <button class="btn-ghost" value="cancel">ุฅูุบุงุก</button>
      <button class="btn-primary" id="adminLoginBtn" value="login">ุฏุฎูู</button>
    </menu>
    <div id="adminLoginMsg" class="status"></div>
  </form>

  <form class="dialog-card" id="adminPanel" hidden method="dialog">
    <h3>ุชุณุฌูู ุงูุญุถูุฑ</h3>
    <div class="toolbar">
      <input id="searchInput" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงูุฌููุณ"/>
      <input id="attDate" type="hidden"/>
      <button class="btn-ghost" id="refreshSubs" type="button">ุชุญุฏูุซ ุงููุงุฆูุฉ</button>
    </div>
    <div id="subsTable" class="table"></div>
    <menu class="dialog-actions">
      <button class="btn-ghost" value="close">ุฅุบูุงู</button>
      <button class="btn-primary" id="saveAttendance" type="button">ุชุณุฌูู ุงูุญุถูุฑ</button>
    </menu>
    <div id="adminMsg" class="status"></div>
  </form>
</dialog>

<footer class="site-footer">
  <a href="https://t.me/Dr_Ahmed_Eisa" target="_blank" rel="noopener noreferrer">Developer: Dr_Ahmed_Eisa</a>
</footer>

<script>
  window.APP_CONFIG = {
    ENDPOINT: "https://script.google.com/macros/s/AKfycbyKTDWKVkMZUxQwKCJRIQx-Bin__47mWQ0WYP4XPDCH5-_eFlZZevg7ytd_zrytzBMn/exec"
  };
</script>
<script src="script.js"></script>


<script>
// ุถุจุท ุชุงุฑูุฎ/ููุช ุงูุญุถูุฑ ุชููุงุฆููุง + ุฅุถุงูุฉ ููุชุฑ ุฏุงุฎู ุฑุฃุณ ุนููุฏ "ุงูุฑุบุจุฉ" ูู ุฌุฏูู ุงูุฃุฏูู
(function(){
  const attDate = document.getElementById('attDate');
  const subsTable = document.getElementById('subsTable');

  function setNow(){
    try{
      const now = new Date();
      if(attDate) attDate.value = now.toISOString();
    }catch(e){}
  }

  // ุฃูุดุฆ ููุชุฑ ุฏุงุฎู ุฑุฃุณ ุงูุนููุฏ "ุงูุฑุบุจุฉ" ุจูุฌุฑุฏ ุชูููู ุงูุฌุฏูู
  function ensureHeaderFilter(){
    if(!subsTable) return;
    const head = subsTable.querySelector('.row.head');
    if(!head) return;
    // ูุง ุชูุดุฆ ุฃูุซุฑ ูู ูุฑุฉ
    if (head.querySelector('.pref-filter-inhead')) return;

    const cells = Array.from(head.querySelectorAll('.cell'));
    if(!cells.length) return;

    // ุญุฏุฏ ููุฑุณ ุนููุฏ "ุงูุฑุบุจุฉ" ูู ูุต ุงูุฎููุฉ
    let prefIdx = cells.findIndex(c => (c.textContent||'').trim().includes('ุงูุฑุบุจุฉ'));
    // ูู ูู ูุฌุฏุ ุญุงูู ุงุนุชูุงุฏู ูุฃูู ุนููุฏ ูุตู
    if (prefIdx < 0) prefIdx = 0;

    const prefHeaderCell = cells[prefIdx];

    // ุงุฌูุน ุงูููู ุงููุฑูุฏุฉ ูู ูู ุงูุตููู
    const rows = Array.from(subsTable.querySelectorAll('.row')).filter(r => !r.classList.contains('head'));
    const prefs = new Set();
    rows.forEach(r => {
      const tds = Array.from(r.querySelectorAll('.cell'));
      const val = (tds[prefIdx] ? tds[prefIdx].textContent : '').trim();
      if (val) prefs.add(val);
    });

    // ุงุจูู ุนูุตุฑ select ุฏุงุฎู ุฑุฃุณ ุงูุนููุฏ
    const select = document.createElement('select');
    select.className = 'pref-filter-inhead';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = 'ูู ุงูุฑุบุจุงุช';
    select.appendChild(optAll);
    Array.from(prefs).sort().forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      select.appendChild(o);
    });

    // ุฃูุฑุบ ูุต ุฑุฃุณ ุงูุฎููุฉ ูุถุน ุฏุงุฎูู ุงูููุชุฑ
    prefHeaderCell.textContent = '';
    const wrap = document.createElement('div');
    wrap.style.display = 'flex';
    wrap.style.flexDirection = 'column';
    wrap.style.gap = '6px';
    const label = document.createElement('div');
    label.textContent = 'ุงูุฑุบุจุฉ';
    label.style.fontWeight = '700';
    label.style.fontSize = '14px';
    label.style.lineHeight = '1';
    wrap.appendChild(label);
    wrap.appendChild(select);
    prefHeaderCell.appendChild(wrap);

    // ูุนู ุงูุชุตููุฉ
    select.addEventListener('change', () => applyFilter(prefIdx, select.value));
  }

  function applyFilter(prefIdx, wanted){
    const rows = Array.from(subsTable.querySelectorAll('.row')).filter(r => !r.classList.contains('head'));
    rows.forEach(r => {
      const cells = Array.from(r.querySelectorAll('.cell'));
      const val = (cells[prefIdx] ? cells[prefIdx].textContent : '').trim();
      const show = !wanted || val === wanted;
      r.style.display = show ? '' : 'none';
    });
  }

  // ุฑุงูุจ ุงูุฌุฏูู ูุฃู ุชุญุฏูุซ (ุนูุฏ ุงูุถุบุท ุนูู "ุชุญุฏูุซ ุงููุงุฆูุฉ" ูุซูุงู)
  const mo = new MutationObserver(() => {
    // ุงูุชุธุฑ ุฏูุฑุฉ ุฑุณู DOM ุญุชู ุชูุชูู ุงูุตููู
    requestAnimationFrame(ensureHeaderFilter);
  });
  if (subsTable) mo.observe(subsTable, { childList: true, subtree: true });

  // ุชููุฆุฉ ุฃูููุฉ
  window.addEventListener('DOMContentLoaded', () => {
    setNow();
    ensureHeaderFilter();
  });
})();
</script>

</body>
</html>
